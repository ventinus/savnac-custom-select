!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n():"function"==typeof define&&define.amd?define(n):n()}(0,function(){"use strict";var e=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},n=function(e){if(Array.isArray(e)){for(var n=0,t=Array(e.length);n<e.length;n++)t[n]=e[n];return t}return Array.from(e)},t=require("lodash"),o=t.omit,i=t.template,r=t.forEach,l=t.clamp,u=t.reduce,c=require("savnac-utils"),a=c.htmlToElement,s=c.empty,d={selectEl:void 0,btnLabel:"Button",btnMarkup:"<button><%- btnText %></button>",optionMarkup:"<li><%- option %></li>",ulMarkup:"<ul></ul>",onFocus:function(e){console.log("button focus",e)},onBlur:function(e){console.log("button blur",e)},onChange:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{prevValue:0,nextValue:1};console.log("select change",e,n)},onEnabledChange:function(e,n){console.log("enabled state change",e,n)}},f=function(){function t(e){return f[e]||d[e]}function c(e){if(v.isEnabled){r(h.ulChildren,function(e,n){e.removeEventListener("click",b["onLiClick-"+n])}),b={},s(h.select),s(h.ul);var n=i('<option value="<%- val %>"><%- val %></option>');e.forEach(function(e){h.select.appendChild(a(n({val:e}))),h.ul.appendChild(a(v.optionTemplate({option:e})))}),v.optionValues=e,h.selectOptions=h.select.querySelectorAll("option"),h.ulChildren=h.ul.children,r(h.ulChildren,function(e,n){b["onLiClick-"+n]=L(n),e.addEventListener("click",b["onLiClick-"+n])}),I(),V()}}var f=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},p=["btnMarkup","optionMarkup","ulMarkup"],v=e({isEnabled:!1,selectEnabled:!0,isFocused:!1,btnTemplate:i(t("btnMarkup")),optionTemplate:i(t("optionMarkup")),ulMarkup:t("ulMarkup"),currentModifierKeys:[],optionValues:[],current:{letter:"",count:0,index:-1},notOnPage:!1,measurements:{}},o(d,p),o(f,p)),h={},b={},m=["Meta","Alt","Control","Shift","Enter"],g={options:c},E=function(){if(h.select=v.selectEl,!h.select)return v.notOnPage=!0,void console.info("Provided select element not defined. Preventing CustomSelect enable.");h.selectOptions=h.select.querySelectorAll("option"),h.selectWrapper=h.select.parentElement},C=function(){h.btn=a(v.btnTemplate({btnText:v.btnLabel})),h.selectWrapper.appendChild(h.btn),h.ul=a(v.ulMarkup),h.selectWrapper.appendChild(h.ul),r(h.selectOptions,function(e){h.ul.appendChild(a(v.optionTemplate({option:e.value}))),v.optionValues.push(e.value)}),h.ulChildren=h.ul.children,V()},y=function(){v.measurements={ulHeight:h.ul.offsetHeight,liHeight:h.ulChildren.length>0?h.ulChildren[0].offsetHeight:0}},k=function(e){v.selectEnabled&&!v.isFocused&&(v.isFocused=!0,v.focusTimeStamp=e.timeStamp,w(!0,y),v.onFocus(e.currentTarget),window.addEventListener("keydown",F),window.addEventListener("keyup",H),window.addEventListener("click",M))},w=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};Velocity(h.ul,e?"slideDown":"slideUp",{complete:n,duration:300})},L=function(e){return function(){return K(e)}},M=function(e){e.timeStamp-v.focusTimeStamp>200&&x()},x=function(){v.currentModifierKeys=[],w(!1),v.onBlur(h.btn),window.removeEventListener("keydown",F),window.removeEventListener("keyup",H),window.removeEventListener("click",M),v.isFocused=!1},A=function(e){return l(e,0,h.selectOptions.length-1)},O=function(e){var n=e?1:-1;K(A(h.select.selectedIndex+n))},T=function(e){return function(n){var t=h.ulChildren[n];if(t){var o=e?"add":"remove",i=e?"setAttribute":"removeAttribute";if(t.classList[o]("is-selected"),h.select.children[n][i]("selected",""),e){var r=v.measurements,l=r.ulHeight,u=r.liHeight,c=h.ulChildren[n].offsetTop,a=h.ul.scrollTop;(c<a||c>=a+l-u)&&(h.ul.scrollTop=c)}}}},P=T(!0),S=T(!1),K=function(e){var n=h.select.selectedIndex;n!==e&&(S(n),P(e),v.onChange(h.btn,{prevIndex:n,nextIndex:e}),h.select.selectedIndex=e)},V=function(){var e=h.ulChildren.length>0;if(v.selectEnabled!==e){v.selectEnabled=e;var n=v.selectEnabled?"removeAttribute":"setAttribute";h.select[n]("disabled",""),h.btn[n]("disabled",""),v.onEnabledChange(h.btn,v.selectEnabled)}},F=function(e){var n=e.key;if(m.includes(n)&&v.currentModifierKeys.push(n),"Tab"===n)return void x();if(!(v.currentModifierKeys.length>0)){switch(e.preventDefault(),n){case"ArrowUp":return void O(!1);case"ArrowDown":return void O(!0)}if(1===n.length&&n.match(/[a-zA-Z0-9]/)){if(n===v.current.letter)v.current.count++;else{v.current.count=0;var t=v.optionValues.reduce(function(e,t,o){return e>=0?e:t.charAt(0).toLowerCase()>=n.toLowerCase()?o:-1},-1);v.current.index=t<0?v.optionValues.length-1:t,v.current.letter=n}K(A(v.current.index+v.current.count))}}},H=function(e){var t=e.key,o=v.currentModifierKeys.indexOf(t);o<0||(v.currentModifierKeys=[].concat(n(v.currentModifierKeys.slice(0,o)),n(v.currentModifierKeys.slice(o+1))))},I=function(){var e=(h.select.selectedIndex,u(h.selectOptions,function(e,n,t){return e>-1?e:n.getAttribute("selected")?t:e},-1));K(e)},q=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};for(var n in e)e.hasOwnProperty(n)&&g.hasOwnProperty(n)&&g[n](e[n])},j=function(){v.isEnabled&&K(-1)},B=function(){var e=h.btn.parentNode;e.removeChild(h.btn),e.removeChild(h.ul)},D=function(){E(),v.notOnPage||(C(),y(),I())},W=function(e){return function(){if(e!==v.isEnabled&&!v.notOnPage){var n=e?"add":"remove";h.btn[n+"EventListener"]("click",k),h.btn[n+"EventListener"]("focus",k),r(h.ulChildren,function(e,t){b["onLiClick-"+t]=L(t),e[n+"EventListener"]("click",b["onLiClick-"+t])}),e||B(),v.isEnabled=e}}};return{init:D,updateSelect:q,clear:j,enable:W(!0),disable:W(!1)}};module.exports=f});